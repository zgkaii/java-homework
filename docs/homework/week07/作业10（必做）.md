# 作业10

**题目描述**：读写分离 - 数据库框架版本 2.0。

* 使用 ShardingSphere-jdbc 5.0.0-alpha 实现读写分离配置。

> 官网中文文档：[https://shardingsphere.apache.org/document/current/cn/overview/](https://links.jianshu.com/go?to=https%3A%2F%2Fshardingsphere.apache.org%2Fdocument%2Fcurrent%2Fcn%2Foverview%2F)
>  官方使用示例github地址：[https://github.com/apache/shardingsphere/tree/master/examples](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fapache%2Fshardingsphere%2Ftree%2Fmaster%2Fexamples)

------

> 代码 —— [misson10](https://github.com/zgkaii/java-homework/tree/main/week07-shardingsphere)

## 1 创建表

```mysql
DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
   `id`          int not null comment '用户id',
   `name`        varchar(10) not null comment '用户名',
   `password`    varchar(8) not null comment '密码',
   `sex`         varchar(2) not null comment '性别',
   `birthday`    datetime comment '生日'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

ALTER TABLE `user`
   ADD PRIMARY KEY (`id`);
   
INSERT INTO user(id,name,password,sex,birthday) VALUES (1,'张三','12345678','男性','2018-08-08 22:20:46');
```

## 2 编写pom.xml

```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>1.3.2</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
            <version>1.1.10</version>
        </dependency>
        <dependency>
            <groupId>org.apache.shardingsphere</groupId>
            <artifactId>shardingsphere-jdbc-core-spring-boot-starter</artifactId>
            <version>5.0.0-alpha</version>
        </dependency>
```

## 3 编写application.yml

```yml
server:
  port: 8090

spring:
  enabled: true # 是否启用sharding
  shardingsphere:
    props: # 打印sql
      sql-show: true
    datasource:
      common:
        driver-class-name: com.mysql.cj.jdbc.Driver
        type: com.alibaba.druid.pool.DruidDataSource
      # 数据库别名
      names: ds1,ds2,ds3
      ds1:
        url: jdbc:mysql://localhost:3316/db?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=GMT%2b8
        username: root
        password: 513701
      ds2:
        url: jdbc:mysql://localhost:3326/db?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=GMT%2b8
        username: root
        password: 513701
      ds3:
        url: jdbc:mysql://localhost:3326/db?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=GMT%2b8
        username: root
        password: 513701
    rules:
      replica-query:
        load-balancers:
          # 负载均衡算法
          round-robin:
            type: ROUND_ROBIN
            props:
              default: 0
        data-sources:
          # 主从名称，可任意写
          props:
            # 配置主库,负责数据写入
            primary-data-source-name: ds1
            # 配置从库节点
            replica-data-source-names: ds2,ds3
            # 配置从库节点负载均衡策略，采用轮询机制
            load-balancer-name: round_robin

mybatis:
  type-aliases-package: com.zgkaii.sharding.entity
  mapper-locations: classpath:/mapper/*.xml
```

## 4 entity、mapper、controlller

创建实体类：

```java
@Data
public class User {
    private Integer id;
    private String name;
    private String password;
    private String sex;
    private Date birthday;
}
```

创建UserMapper：

```java
@Mapper
public interface UserMapper {
    /**
     * 获取全部数据
     */
    List<User> query();

    /**
     * 插入一条数据
     */
    void insert(User user);
}
```

创建UserMapper.xml：

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zgkaii.sharding.mapper.UserMapper">
    <select id="query" resultType="com.zgkaii.sharding.entity.User">
        SELECT * FROM user
    </select>

    <insert id="insert" parameterType="com.zgkaii.sharding.entity.User">
        INSERT INTO user(id,name,password,sex,birthday) VALUES (#{id},#{name},#{password},#{sex},#{birthday})
    </insert>
</mapper>
```

创建StudentController：

```java
@RestController
@RequestMapping("/user")
public class StudentController {

    @Autowired
    UserMapper userMapper;

    @GetMapping("/query")
    public List<User> query() {
        return userMapper.query();
    }

    @GetMapping("/insert")
    public void insert(User user) {
        userMapper.insert(user);
    }
}
```

## 5 启动测试

启动SpringBootApplication，查询数据：

<div align="center">  
<img src="https://img-blog.csdnimg.cn/20210515101001338.png" width="600px"/>
</div>

刷新多次查询，控制台输出：

```html
xxx  INFO 22776 --- [nio-8090-exec-1] ShardingSphere-SQL: Logic SQL: SELECT * FROM user
xxx  INFO 22776 --- [nio-8090-exec-1] ShardingSphere-SQL: SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty)
xxx  INFO 22776 --- [nio-8090-exec-1] ShardingSphere-SQL: Actual SQL: ds2 ::: SELECT * FROM user
xxx  INFO 22776 --- [nio-8090-exec-2] ShardingSphere-SQL: Logic SQL: SELECT * FROM user
xxx  INFO 22776 --- [nio-8090-exec-2] ShardingSphere-SQL: SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty)
xxx  INFO 22776 --- [nio-8090-exec-2] ShardingSphere-SQL: Actual SQL: ds3 ::: SELECT * FROM user
xxx  INFO 22776 --- [nio-8090-exec-3] ShardingSphere-SQL: Logic SQL: SELECT * FROM user
xxx  INFO 22776 --- [nio-8090-exec-3] ShardingSphere-SQL: SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty)
xxx  INFO 22776 --- [nio-8090-exec-3] ShardingSphere-SQL: Actual SQL: ds2 ::: SELECT * FROM user
```

可见读操作的确只在ds2与ds3中进行。

编写测试方法：

```java
    @Test
    void writeAndRead() {
        System.out.println("===> 查询数据：" + studentController.query());

        User user = new User();
        user.setId(2);
        user.setName("李四");
        user.setPassword("12345678");
        user.setSex("女性");
        user.setBirthday(java.sql.Date.valueOf(java.time.LocalDate.now()));
        studentController.insert(user);

        System.out.println("===> 查询数据：" + studentController.query());
    }
```

执行结果：

```html
--- omit ---
xxx  INFO 13936 --- [main] ShardingSphere-SQL: Logic SQL: SELECT * FROM user
xxx  INFO 13936 --- [main] ShardingSphere-SQL: SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty)
xxx  INFO 13936 --- [main] ShardingSphere-SQL: Actual SQL: ds2 ::: SELECT * FROM user
===> 查询数据：[User(id=1, name=张三, password=12345678, sex=男性, birthday=Wed Aug 08 22:20:46 CST 2018)]
xxx  INFO 13936 --- [main] ShardingSphere-SQL: Logic SQL: INSERT INTO user(id,name,password,sex,birthday) VALUES (?,?,?,?,?)
xxx  INFO 13936 --- [main] ShardingSphere-SQL: SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
xxx  INFO 13936 --- [main] ShardingSphere-SQL: Actual SQL: ds1 ::: INSERT INTO user(id,name,password,sex,birthday) VALUES (?,?,?,?,?) ::: [2, 李四, 12345678, 女性, 2021-05-15 00:00:00.0]
xxx  INFO 13936 --- [main] ShardingSphere-SQL: Logic SQL: SELECT * FROM user
xxx  INFO 13936 --- [main] ShardingSphere-SQL: SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty)
xxx  INFO 13936 --- [main] ShardingSphere-SQL: Actual SQL: ds3 ::: SELECT * FROM user
===> 查询数据：[User(id=1, name=张三, password=12345678, sex=男性, birthday=Wed Aug 08 22:20:46 CST 2018), 				User(id=2, name=李四, password=12345678, sex=女性, birthday=Sat May 15 00:00:00 CST 2021)]
--- omit ---
```

至此，我们已经实现基本的数据分片与读取分离。