- [作业2](#作业2)
  - [1 初始化数据库](#1-初始化数据库)
  - [2 配置server.yaml与config-sharding.yaml](#2-配置serveryaml与config-shardingyaml)
  - [3 连接数据库](#3-连接数据库)
  - [4 增删改查](#4-增删改查)
- [作业3](#作业3)

# 作业2

**题目描述**：设计对前面的订单表数据进行水平分库分表，拆分 2 个库，每个库 16 张表，并演示常见的增删改查操作。

------

## 1 初始化数据库

创建两个数据库`learn_ds_0`与`learn_ds_1`，每个数据库中创建16张表——`orders_0~orders_15`，每张表中插入一条数据[初始化SQL](https://github.com/zgkaii/java-homework/homework/week08/init.sql)。

```mysql
mysql> show tables; # schema: learn_ds_0
+----------------------+
| Tables_in_learn_ds_0 |
+----------------------+
| orders_0             |
| orders_1             |
| orders_10            |
| orders_11            |
| orders_12            |
| orders_13            |
| orders_14            |
| orders_15            |
| orders_2             |
| orders_3             |
| orders_4             |
| orders_5             |
| orders_6             |
| orders_7             |
| orders_8             |
| orders_9             |
+----------------------+

mysql> show tables; # schema: learn_ds_1
+----------------------+
| Tables_in_learn_ds_1 |
+----------------------+
| orders_0             |
| orders_1             |
| orders_10            |
| orders_11            |
| orders_12            |
| orders_13            |
| orders_14            |
| orders_15            |
| orders_2             |
| orders_3             |
| orders_4             |
| orders_5             |
| orders_6             |
| orders_7             |
| orders_8             |
| orders_9             |
+----------------------+
```

## 2 配置server.yaml与config-sharding.yaml

下载 [ShardingSphere-Proxy](https://www.apache.org/dyn/closer.cgi/shardingsphere/5.0.0-alpha/apache-shardingsphere-5.0.0-alpha-shardingsphere-proxy-bin.tar.gz)

`server.yaml：`

```yaml
authentication:
  users:
    root:
      password: root
      
props:
  max-connections-size-per-query: 1
  acceptor-size: 16  # The default value is available processors count * 2.
  executor-size: 16  # Infinite by default.
  proxy-frontend-flush-threshold: 128  # The default value is 128.
#    # LOCAL: Proxy will run with LOCAL transaction.
#    # XA: Proxy will run with XA transaction.
#    # BASE: Proxy will run with B.A.S.E transaction.
  proxy-transaction-type: LOCAL
  proxy-opentracing-enabled: false
  proxy-hint-enabled: false
  query-with-cipher-column: true
  sql-show: true
  check-table-metadata-enabled: false
```

`config-sharding.yaml`

```yaml
schemaName: sharding_db

dataSourceCommon:
  username: zgkaii
  password: 513701
  connectionTimeoutMilliseconds: 30000
  idleTimeoutMilliseconds: 60000
  maxLifetimeMilliseconds: 1800000
  maxPoolSize: 50
  minPoolSize: 1
  maintenanceIntervalMilliseconds: 30000

dataSources:
  ds_0:
    url: jdbc:mysql://127.0.0.1:3317/learn_ds_0?serverTimezone=UTC&useSSL=false
  ds_1:
    url: jdbc:mysql://127.0.0.1:3317/learn_ds_1?serverTimezone=UTC&useSSL=false

rules:
- !SHARDING
  tables:
    t_order:
      actualDataNodes: ds_${0..1}.orders_${0..15}
      tableStrategy:
        standard:
          shardingColumn: order_id
          shardingAlgorithmName: t_order_inline
      keyGenerateStrategy:
        column: order_id
        keyGeneratorName: snowflake
  defaultDatabaseStrategy:
    standard:
      shardingColumn: user_id
      shardingAlgorithmName: database_inline
  defaultTableStrategy:
    none:
  
  shardingAlgorithms:
    database_inline:
      type: INLINE
      props:
        algorithm-expression: ds_${user_id % 2}
    t_order_inline:
      type: INLINE
      props:
        algorithm-expression: orders_${order_id % 15}

  keyGenerators:
    snowflake:
      type: SNOWFLAKE
      props:
        worker-id: 123
```

## 3 连接数据库

启动start.sh：

```shell
zgkaii@xxx > bin/start.sh
Starting the ShardingSphere-Proxy ...
The classpath is .:/mnt/d/workplace/temp/apache/lib/*:/mnt/d/workplace/temp/apache/ext-lib/*
Please check the STDOUT file: /mnt/d/workplace/temp/apache/logs/stdout.log
zgkaii@xxx > tail -f  /mnt/d/workplace/temp/apache/logs/stdout.log
xxx [main] ShardingSphere-metadata - Loading 16 tables' meta data for unconfigured tables.
xxx 15:35:17.721 [main] ShardingSphere-metadata - Loading 16 tables' meta data for unconfigured tables.
xxx 15:35:17.731 [main] ShardingSphere-metadata - Loading 16 tables' meta data for unconfigured tables.
xxx 15:35:17.733 [main] ShardingSphere-metadata - Loading 16 tables' meta data for unconfigured tables.
xxx 15:35:17.740 [main] o.a.s.i.c.s.SchemaContextsBuilder - Load meta data for schema sharding_db finished, cost 85 milliseconds.
Thanks for using Atomikos! Evaluate http://www.atomikos.com/Main/ExtremeTransactions for advanced features and professional support or register at http://www.atomikos.com/Main/RegisterYourDownload to disable this message and receive FREE tips & advice
[INFO ] 15:35:17.919 [main] o.a.s.p.i.i.AbstractBootstrapInitializer - Database name is `MySQL`, version is `5.7.33-0ubuntu0.18.04.1-log`
[INFO ] 15:35:18.181 [main] o.a.s.p.frontend.ShardingSphereProxy - ShardingSphere-Proxy start success.
```

连接数据库：

```mysql
root@LAPTOP-BTULSLNT:/mnt/c/Users/kaiz1# mysql -h 127.0.0.1 -P 3307 -uroot -proot -A
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.33-0ubuntu0.18.04.1-log-ShardingSphere-Proxy 5.0.0-RC1

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> show schemas;
+-------------+
| Database    |
+-------------+
| sharding_db |
+-------------+
1 row in set (0.04 sec)
mysql> use sharding_db
Database changed
```

## 4 增删改查

（1）查询数据

```mysql
mysql> select * from t_order;
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
| orderid | proid | userid | payment | paymenttype | postage | ostatus | paymenttime         |
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
| 0       | 1     |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 1       | 2     |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 2       | 3     |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 3       | 4     |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 4       | 5     |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 5       | 6     |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 6       | 7     |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 7       | 8     |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 8       | 9     |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 9       | 10    |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 10      | 11    |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 11      | 12    |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 12      | 13    |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 13      | 14    |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 14      | 15    |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 15      | 16    |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 0       | 1     |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 1       | 2     |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 2       | 3     |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 3       | 4     |      3 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 4       | 5     |      5 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 5       | 6     |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 6       | 7     |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 7       | 8     |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 8       | 9     |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 9       | 10    |      3 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 10      | 11    |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 11      | 12    |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 12      | 13    |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 13      | 14    |      3 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 14      | 15    |      5 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 15      | 16    |      7 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
32 rows in set (0.05 sec)
```

查看日志：

```shell
[INFO ] 10:50:34.030 [ShardingSphere-Command-12] ShardingSphere-SQL - Logic SQL: select * from t_order
[INFO ] 10:50:34.031 [ShardingSphere-Command-12] ShardingSphere-SQL - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty)
[INFO ] 10:50:34.031 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_0
[INFO ] 10:50:34.037 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_1
[INFO ] 10:50:34.037 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_2
[INFO ] 10:50:34.038 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_3
[INFO ] 10:50:34.038 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_4
[INFO ] 10:50:34.038 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_5
[INFO ] 10:50:34.039 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_6
[INFO ] 10:50:34.039 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_7
[INFO ] 10:50:34.040 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_8
[INFO ] 10:50:34.040 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_9
[INFO ] 10:50:34.040 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_10
[INFO ] 10:50:34.041 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_11
[INFO ] 10:50:34.041 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_12
[INFO ] 10:50:34.042 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_13
[INFO ] 10:50:34.042 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_14
[INFO ] 10:50:34.042 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from orders_15
[INFO ] 10:50:34.042 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_0
[INFO ] 10:50:34.043 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_1
[INFO ] 10:50:34.043 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_2
[INFO ] 10:50:34.043 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_3
[INFO ] 10:50:34.043 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_4
[INFO ] 10:50:34.044 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_5
[INFO ] 10:50:34.044 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_6
[INFO ] 10:50:34.044 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_7
[INFO ] 10:50:34.044 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_8
[INFO ] 10:50:34.044 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_9
[INFO ] 10:50:34.045 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_10
[INFO ] 10:50:34.045 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_11
[INFO ] 10:50:34.045 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_12
[INFO ] 10:50:34.045 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_13
[INFO ] 10:50:34.045 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_14
[INFO ] 10:50:34.046 [ShardingSphere-Command-12] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from orders_15
```

（2）插入数据

```mysql
mysql> INSERT INTO sharing_db.t_order(orderid,proid,userid,payment,paymenttype,postage,ostatus,paymenttime)
    -> VALUES ('16','23',1,'10',1,'20',1,'2020-12-12 01:34:12');
Query OK, 1 row affected (0.20 sec)

mysql> select * from t_order;
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
| orderid | proid | userid | payment | paymenttype | postage | ostatus | paymenttime         |
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
	--- omit ---
| 0       | 1     |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 16      | 23    |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
	--- omit ---
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
33 rows in set (0.04 sec)
```

查看日志：

```shell
[INFO ] 11:10:19.002 [ShardingSphere-Command-6] ShardingSphere-SQL - Logic SQL: INSERT INTO sharing_db.t_order(orderid,proid,userid,payment,paymenttype,postage,ostatus,paymenttime)
VALUES ('16','23',1,'10',1,'20',1,'2020-12-12 01:34:12')
[INFO ] 11:10:19.002 [ShardingSphere-Command-6] ShardingSphere-SQL - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
[INFO ] 11:10:19.002 [ShardingSphere-Command-6] ShardingSphere-SQL - Actual SQL: ds_1 ::: INSERT INTO orders_0(orderid,proid,userid,payment,paymenttype,postage,ostatus,paymenttime)
VALUES ('16', '23', 1, '10', 1, '20', 1, '2020-12-12 01:34:12')
```

（3）更新数据

```mysql
mysql> UPDATE sharing_db.t_order set proid = '66' WHERE orderid = '12';
Query OK, 2 rows affected (0.07 sec)

mysql> select * from t_order;
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
| orderid | proid | userid | payment | paymenttype | postage | ostatus | paymenttime         |
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
	--- omit ---
| 12      | 66    |      2 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
	--- omit ---
| 12      | 66    |      1 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
	--- omit ---
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
33 rows in set (0.04 sec)
```

查看日志：

```mysql
[INFO ] 11:11:53.292 [ShardingSphere-Command-8] ShardingSphere-SQL - Logic SQL: UPDATE sharing_db.t_order set proid = '66' WHERE orderid = '12'
[INFO ] 11:11:53.292 [ShardingSphere-Command-8] ShardingSphere-SQL - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
[INFO ] 11:11:53.293 [ShardingSphere-Command-8] ShardingSphere-SQL - Actual SQL: ds_0 ::: UPDATE orders_12 set proid = '66' WHERE orderid = '12'
[INFO ] 11:11:53.293 [ShardingSphere-Command-8] ShardingSphere-SQL - Actual SQL: ds_1 ::: UPDATE orders_12 set proid = '66' WHERE orderid = '12'
```

（4）删除数据

```mysql
mysql> delete from sharding_db.t_order where userid = 2 or userid = 1;
Query OK, 21 rows affected (0.13 sec)

mysql> select * from t_order;
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
| orderid | proid | userid | payment | paymenttype | postage | ostatus | paymenttime         |
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
| 5       | 6     |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 6       | 7     |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 7       | 8     |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 9       | 10    |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 11      | 12    |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 15      | 16    |      0 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 3       | 4     |      3 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 4       | 5     |      5 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 9       | 10    |      3 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 13      | 14    |      3 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 14      | 15    |      5 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
| 15      | 16    |      7 |   10.00 |           1 |   20.00 |       1 | 2020-12-12 01:34:12 |
+---------+-------+--------+---------+-------------+---------+---------+---------------------+
12 rows in set (0.04 sec)
```

查看日志：

```shell
[INFO ] 11:13:47.703 [ShardingSphere-Command-10] ShardingSphere-SQL - Logic SQL: delete from sharding_db.t_order where userid = 2 or userid = 1
[INFO ] 11:13:47.704 [ShardingSphere-Command-10] ShardingSphere-SQL - SQLStatement: MySQLDeleteStatement(orderBy=Optional.empty, limit=Optional.empty)
[INFO ] 11:13:47.704 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_0 where userid = 2 or userid = 1
[INFO ] 11:13:47.705 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_1 where userid = 2 or userid = 1
[INFO ] 11:13:47.705 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_2 where userid = 2 or userid = 1
[INFO ] 11:13:47.705 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_3 where userid = 2 or userid = 1
[INFO ] 11:13:47.706 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_4 where userid = 2 or userid = 1
[INFO ] 11:13:47.706 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_5 where userid = 2 or userid = 1
[INFO ] 11:13:47.707 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_6 where userid = 2 or userid = 1
[INFO ] 11:13:47.707 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_7 where userid = 2 or userid = 1
[INFO ] 11:13:47.707 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_8 where userid = 2 or userid = 1
[INFO ] 11:13:47.708 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_9 where userid = 2 or userid = 1
[INFO ] 11:13:47.708 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_10 where userid = 2 or userid = 1
[INFO ] 11:13:47.709 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_11 where userid = 2 or userid = 1
[INFO ] 11:13:47.709 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_12 where userid = 2 or userid = 1
[INFO ] 11:13:47.709 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_13 where userid = 2 or userid = 1
[INFO ] 11:13:47.709 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_14 where userid = 2 or userid = 1
[INFO ] 11:13:47.710 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_0 ::: delete from orders_15 where userid = 2 or userid = 1
[INFO ] 11:13:47.710 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_0 where userid = 2 or userid = 1
[INFO ] 11:13:47.711 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_1 where userid = 2 or userid = 1
[INFO ] 11:13:47.711 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_2 where userid = 2 or userid = 1
[INFO ] 11:13:47.711 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_3 where userid = 2 or userid = 1
[INFO ] 11:13:47.711 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_4 where userid = 2 or userid = 1
[INFO ] 11:13:47.712 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_5 where userid = 2 or userid = 1
[INFO ] 11:13:47.712 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_6 where userid = 2 or userid = 1
[INFO ] 11:13:47.712 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_7 where userid = 2 or userid = 1
[INFO ] 11:13:47.712 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_8 where userid = 2 or userid = 1
[INFO ] 11:13:47.712 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_9 where userid = 2 or userid = 1
[INFO ] 11:13:47.713 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_10 where userid = 2 or userid = 1
[INFO ] 11:13:47.713 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_11 where userid = 2 or userid = 1
[INFO ] 11:13:47.713 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_12 where userid = 2 or userid = 1
[INFO ] 11:13:47.713 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_13 where userid = 2 or userid = 1
[INFO ] 11:13:47.713 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_14 where userid = 2 or userid = 1
[INFO ] 11:13:47.714 [ShardingSphere-Command-10] ShardingSphere-SQL - Actual SQL: ds_1 ::: delete from orders_15 where userid = 2 or userid = 1
```



# 作业3

**题目描述**：模拟 1000 万的订单单表数据，迁移到上面作业 2 的分库分表中。

------

> 待完成... ...

| 服务           | 数据库                     | 表      |
| -------------- | -------------------------- | ------- |
| MySQL          | 127.0.0.1:3317/learn       | orders  |
| sharding-proxy | 127.0.0.1:3307/sharding_db | t_order |

按照第七周[作业2](https://github.com/zgkaii/java-homework/blob/main/docs/homework/week07/%E4%BD%9C%E4%B8%9A2%EF%BC%88%E5%BF%85%E5%81%9A%EF%BC%89.md)改进3方法，在learn数据库中orders表中先插入1000万条数据。

```mysql
mysql> show tables;
+-----------------+
| Tables_in_learn |
+-----------------+
| orders          |
+-----------------+
1 row in set (0.00 sec)

mysql> select count(1) from orders;
+----------+
| count(1) |
+----------+
| 10000000 |
+----------+
1 row in set (1.62 sec)
```

下面的任务就是，将`learn`数据库`orders`表中的1000万条数据迁移到`learn_ds_0`与`learn_ds_1`两个数据库中的`orders_0~orders_15`16张表中。

下载[ShardingSphere-Scaling](https://www.apache.org/dyn/closer.cgi/shardingsphere/5.0.0-alpha/apache-shardingsphere-5.0.0-alpha-shardingsphere-scaling-bin.tar.gz)

`sharding-scaling`服务的作用是根据指定源数据和目标数据源进行全量同步，且拉取源数据binlog日志进行增量更新。

启动：

```shell
 zgkaii@xxx > ./bin/start.sh
Starting the ShardingSphere-Scaling ...
Please check the STDOUT file: /mnt/d/workplace/temp/scaling/logs/stdout.log
 zgkaii@xxx >  tail -f /mnt/d/workplace/temp/scaling/logs/stdout.log
xxx |-INFO in ch.qos.logback.core.joran.action.AppenderRefAction - Attaching appender named [console] to Logger[ROOT]
xxx |-INFO in ch.qos.logback.classic.joran.action.ConfigurationAction - End of configuration.
xxx |-INFO in ch.qos.logback.classic.joran.JoranConfigurator@3cb5cdba - Registering current configuration as safe fallback point

[INFO ] 20:30:24.194 [main] o.a.shardingsphere.scaling.Bootstrap - Init server config
[INFO ] 20:30:24.483 [main] o.a.shardingsphere.scaling.Bootstrap - ShardingSphere-Scaling Startup
[INFO ] 20:30:24.875 [nioEventLoopGroup-2-1] i.n.handler.logging.LoggingHandler - [id: 0x9093be0d] REGISTERED
[INFO ] 20:30:24.879 [nioEventLoopGroup-2-1] i.n.handler.logging.LoggingHandler - [id: 0x9093be0d] BIND: 0.0.0.0/0.0.0.0:8888
[INFO ] 20:30:24.881 [main] o.a.shardingsphere.scaling.Bootstrap - ShardingSphere-Scaling is server on http://127.0.0.1:8888/
[INFO ] 20:30:24.884 [nioEventLoopGroup-2-1] i.n.handler.logging.LoggingHandler - [id: 0x9093be0d, L:/0.0.0.0:8888] ACTIVE
```

使用 curl 命令再次确认正常运行。

```shell
curl -X GET http://localhost:8888/scaling/job/list
```

响应应为：

```shell
{"success":true,"errorCode":0,"errorMsg":null,"model":[]}
```

发送请求：

```shell
curl -X POST \
  http://localhost:8888/shardingscaling/job/start \
  -H 'content-type: application/json' \
  -d '{
   "ruleConfiguration": {
      "sourceDatasource": "ds_0: !!org.apache.shardingsphere.orchestration.core.configuration.YamlDataSourceConfiguration\n  dataSourceClassName: com.zaxxer.hikari.HikariDataSource\n  driverClassName: com.mysql.cj.jdbc.Driver\n properties:\n    jdbcUrl: jdbc:mysql://127.0.0.1:3317/learn?serverTimezone=UTC&useSSL=false\n    username: root\n    password: '\''513701'\''\n    connectionTimeout: 30000\n    idleTimeout: 60000\n    maxLifetime: 1800000\n    maxPoolSize: 50\n    minPoolSize: 1\n    maintenanceIntervalMilliseconds: 30000\n    readOnly: false\n",
      "sourceRule": "tables:\n  t_order:\n  actualDataNodes: ds_0.orders\n    keyGenerator:\n      column: order_id\n      type: SNOWFLAKE\n",
      "destinationDataSources": {
         "name": "dt_0",
         "password": "root",
         "url": "jdbc:mysql://127.0.0.1:3307/sharding_db?serverTimezone=UTC&useSSL=false",
         "username": "root"
      }
   },
   "jobConfiguration": {
      "concurrency": 3
   }
}'
```

> 没有响应，待解决... ...



https://shardingsphere.apache.org/document/legacy/4.x/document/cn/manual/sharding-scaling/usage/